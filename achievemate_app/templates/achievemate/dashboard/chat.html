{% extends "achievemate/dashboard/dashboard_base.html" %}
{% load static %}
{% block content %}
{% load custom_filters %}
<style>
    .chatsend-btn a.disabled {
        color: gray;
        pointer-events: none;
        cursor: not-allowed;
    }
    
</style>
    <!-- page-layout Start -->
    <section class="page-layout">
        <!-- mobile_view_header Start-->
        <header class="header mobile_view_header">
            <div class="container-fluid">
                <div class="nav-main">
                    <div class="logo-wrapper">
                        <div class="navbar-brand">
                            <a class="" href="#">
                                <img src="{% static 'assets/img/logo.svg' %}" alt="logo">
                            </a>
                        </div>
                    </div>
                    <!-- minimize_toggle -->
                    <div class="header-wrapper">
                        <span class="minimize_toggle">
                            <i class="ri-arrow-right-s-line"></i>
                        </span>
                    </div>
                </div>
            </div>
        </header>
        <!-- mobile_view_header END-->

         <!-- page-topbar Start -->
         <div class="page-topbar">
            <div class="conteiner-fluid">
                <div class="row align-items-center">
                    <div class="col-12">
                        <!-- breadcrumb -->
                        <div class="breadcrumb-wrap">
                            <nav aria-label="breadcrumb">
                                <ul class="breadcrumb">
                                    <li class="breadcrumb-item">Pages</li>
                                    <li class="breadcrumb-item" aria-current="page">Chat</li>
                                </ul>
                            </nav>
                            <!-- page-title -->
                            <div class="page-title">
                                <h2><a href="{% url 'dashboard' %}"><i class="ri-arrow-left-line"></i></a> Chat</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- page-topbar END -->

        <!-- main-content start  -->
        <div class="main-content">
            <div class="row">
                <div class="col-12">
                    <!-- section-title -->
                    <div class="section-title">
                        <h4>CHAT WITH  coach's</h4>
                    </div>
                </div>
            </div>
            <div class="row g-4 mt-0">
                <div class="col-lg-12 col-xl-5 col-md-12">
                    <div class="row g-4">
                        <div class="col-12">
                            <!-- chat-owner-list Start -->
                            <div class="chat-owner-list">
                                <!-- chat-owner-body Start -->
                                <div class="chat-owner-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <!-- chat-sender-list Start -->
                                            <div class="chat-sender-list">
                                                <ul>
                                                    {% for coach in coaches_data %}
                                                    <!-- Loop Start  -->
                                                    <li class="view-chat {% if forloop.first %}first-item{% endif %}" data-coach-id="{{ coach.id }}"><!-- add view-chat class on click  -->
                                                        <div class="chat-sender">
                                                            <!-- sender-img -->
                                                            <div class="sender-img">
                                                                <img src="{{coach.coach_profile_image.url}}" alt="">
                                                            </div>
                                                            <div class="sender-massage">
                                                                <!-- sender-name  -->
                                                                <h5 class="sender-name">{{coach.coach_name}}</h5>
                                                                <p class="sender-text">{{coach.coach_expertise}}</p>
                                                            </div>
                                                        </div>
                                                    </li>
                                                  
                                                    <!-- Loop END  -->
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <!-- chat-sender-list END -->
                                            
                                        </div>
                                    </div>
                                </div>
                                <!-- chat-owner-body END -->
                            </div>
                            <!-- chat-owner-list END -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-12 col-xl-7 col-md-12">
                    <div class="card chat-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="chat-wrapper">
                                        <!-- usertalk-wrapper Start -->
                                        <div class="usertalk-wrapper" id="messages">
                                            <!-- owner msg  -->
                                            {% comment %} <div class="usertalk-inner">
                                                <div class="chatuser-img">
                                                    <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                                                </div>
                                                <div class="userleft-msg">
                                                    <!-- msg display  -->
                                                    <img src="{% static 'assets/img/icon/svg/send-file.svg' %}" alt="icon/svg/send-file" class="send-file" />
                                                    <span>Review this test and provide feedback on how it can be improved or adjusted to better measure the student's knowledge and understanding of the subject being tested.</span>
                                                    <div class="msg-dt">
                                                        <!-- time  -->
                                                        <label>Just now</label>
                                                        <div class="action-button-list">
                                                            <button class="btn-scolor"><i class="ri-add-line"></i>Add to task</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- msg reply -->
                                            <div class="usertalk-inner reply-inner">
                                                <div class="chatuser-img">
                                                    <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                                                </div>
                                                <div class="userleft-msg">
                                                    
                                                    <span> Review this test and provide feedback on how it can be improved or adjusted to better measure the student's knowledge and understanding of the subject being tested.</span>
                                                    <div class="msg-dt">
                                                        <label>just now</label>
                                                        <div class="action-button-list">
                                                            <button class="btn-scolor"><i class="ri-add-line"></i>Add to task</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="usertalk-inner" id="typing-indicator">
                                                <div class="chatuser-img">
                                                    <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                                                </div>
                                                <div class="userleft-msg">
                                                    <!-- typing -->
                                                    <span>
                                                        <div class="typing">
                                                            <span class="circle"></span>
                                                            <span class="circle"></span>
                                                            <span class="circle"></span>
                                                        </div>
                                                    </span>
                                                    <!-- puase btn  -->
                                                    <div class="msg-dt">
                                                        <button class="btn-scolor"><i class="ri-add-line"></i>Add to task</button>
                                                    </div>
                                                </div>
                                            </div> {% endcomment %}
                                        </div>
                                        <!-- usertalk-wrapper END -->
                                        <div  id="recommendquestions" hidden>
                                            <ul>
                                                <!-- Loop through questions -->  
                                                
                                            </ul>
                                        </div>
                                        <!-- chattype-wrapper start  -->
                                        <div class="chattype-wrapper">
                                            <div class="typeinput-wrapper">
                                                <!-- file upload btn -->
                                                <div class="input-file-icon">
                                                    <div class="upload-btn-wrapper">
                                                        <button class="border-0 p-0 bg-transparent"><img src="{% static 'assets/img/icon/svg/input-file.svg' %}" alt="icon/input-file"></button>
                                                        <input type="file" name="myfile">
                                                    </div>
                                                </div>
                                                <div class="input-main-input">
                                                    <input type="text" id='message-input' class="form-control" placeholder="Type '/' for commands">
                                                </div>
                                                <!-- chatsend-btn -->
                                                <div class="chatsend-btn">
                                                    <a class="" id="send-btn">
                                                        <i class="ri-send-plane-fill"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- chattype-wrapper END  -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- main-content END -->
    </section>
    <!-- page-layout END -->
    {% endblock %}
    {% block script %}
    <script>
        const uid = "{{uid}}" ? "{{uid}}" : 0;
        const cid = "{{cid}}" ? "{{cid}}" : 0;
        {% comment %} console.log(uid,cid); {% endcomment %}
        const roomName = `room_${uid}_${cid}`;
        // Use appropriate protocol based on current page protocol
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socket = new WebSocket(
            protocol +
            window.location.host +
            '/ws/chat/' +
            roomName +
            '/'
        );
        console.log(socket)
        // Event listeners
        socket.onopen = function(event) {
            console.log('WebSocket connection established');
        };
        
        socket.onerror = function(event) {
            console.error('WebSocket error:', event);
        };
        
        socket.onclose = function(event) {
            console.log('WebSocket connection closed:', event.code, event.reason);
        };

        socket.onmessage = function(event) {
            console.log('Received WebSocket message:', event.data);
            try {
                const data = JSON.parse(event.data);
                console.log('Parsed message data:', data);
                
                if (data.status === 'thinking') {
                    console.log('Coach is thinking...');
                    showThinkingIndicator();
                } else if (data.message) {
                    console.log('Received coach response:', data.message);
                    if (data.audio_url) {
                        console.log('Received audio URL:', data.audio_url);
                    } else if (data.use_browser_tts) {
                        console.log('Using browser TTS with voice:', data.voice_type);
                    }
                    hideThinkingIndicator();
                    displayCoachMessage(data.message, {
                        audio_url: data.audio_url,
                        use_browser_tts: data.use_browser_tts,
                        tts_text: data.tts_text,
                        voice_type: data.voice_type
                    });
                    // Try to update messages from server, but don't fail if it doesn't work
                    updateMessages();
                }
            } catch (e) {
                console.error('Error parsing WebSocket message:', e);
            }
        };
        function removeAnswerPrefix(message) {
            if (message.startsWith("answer:")) {
                return message.substring(7).trim();
            } else if (message.startsWith("Answer:")) {
                return message.substring(7).trim();
            }
            //console.log("inside remove answer prefix\n",message)
            return message;
        }

        // Function to display coach message directly in chat
        function displayCoachMessage(message, audioOptions = {}) {
            const cleanMessage = removeAnswerPrefix(message);
            const formattedMessage = cleanMessage
                .replace(/\\n/g, "<br>")
                .replace(/\\n\\n/g, "<br><br>")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\\'/g, "'")
                .replace(/###/g, '');

            let audioHtml = '';
            const uniqueId = 'audio_' + Date.now();
            
            // Handle audio playback
            if (audioOptions.audio_url) {
                // Server-generated audio file
                audioHtml = `
                    <div class="coach-audio-container" style="margin-bottom: 10px;">
                        <audio controls autoplay style="max-width: 300px;">
                            <source src="${audioOptions.audio_url}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                `;
            } else if (audioOptions.use_browser_tts) {
                // Browser Text-to-Speech fallback
                audioHtml = `
                    <div class="coach-tts-container" style="margin-bottom: 10px;">
                        <button onclick="playBrowserTTS('${uniqueId}', '${audioOptions.voice_type || 'female'}')" 
                                class="btn btn-sm btn-outline-primary">
                            <i class="ri-volume-up-line"></i> Play Audio
                        </button>
                        <span id="${uniqueId}" style="display: none;">${audioOptions.tts_text || cleanMessage}</span>
                    </div>
                `;
            }

            const messageHtml = `
                <div class="usertalk-inner reply-inner">
                    <div class="chatuser-img">
                        <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                    </div>
                    <div class="userleft-msg">
                        ${audioHtml}
                        <span>${formattedMessage}</span>
                        <div class="msg-dt">
                            <button class="btn-scolor"><i class="ri-add-line"></i>Add to task</button>
                        </div>
                    </div>
                </div>
            `;
            
            $('#messages').append(messageHtml);
            
            // Scroll to bottom
            var chatWindow = $('#messages');
            chatWindow.scrollTop(chatWindow[0].scrollHeight);
            
            // Auto-play browser TTS if no server audio
            if (audioOptions.use_browser_tts && !audioOptions.audio_url) {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    playBrowserTTS(uniqueId, audioOptions.voice_type || 'female');
                }, 500);
            }
        }

        // Function to play text using browser's built-in TTS
        function playBrowserTTS(elementId, voiceType) {
            if ('speechSynthesis' in window) {
                const text = document.getElementById(elementId).textContent;
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Configure voice based on type
                const voices = speechSynthesis.getVoices();
                let selectedVoice = null;
                
                if (voiceType === 'male') {
                    selectedVoice = voices.find(voice => 
                        voice.name.toLowerCase().includes('male') || 
                        voice.name.toLowerCase().includes('david') ||
                        voice.name.toLowerCase().includes('mark')
                    );
                } else {
                    selectedVoice = voices.find(voice => 
                        voice.name.toLowerCase().includes('female') || 
                        voice.name.toLowerCase().includes('zira') ||
                        voice.name.toLowerCase().includes('samantha')
                    );
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                // Set speech parameters
                utterance.rate = 0.9; // Slightly slower for clarity
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                // Play the speech
                speechSynthesis.speak(utterance);
                
                console.log('Playing browser TTS with voice:', selectedVoice ? selectedVoice.name : 'default');
            } else {
                console.warn('Browser TTS not supported');
            }
        }

        // Function to show thinking indicator
        function showThinkingIndicator() {
            const thinkingHtml = `
                <div id="thinking-indicator" class="usertalk-inner reply-inner">
                    <div class="chatuser-img">
                        <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                    </div>
                    <div class="userleft-msg">
                        <span>
                            <div class="typing">
                                <span class="circle"></span>
                                <span class="circle"></span>
                                <span class="circle"></span>
                            </div>
                        </span>
                    </div>
                </div>
            `;
            $('#messages').append(thinkingHtml);
            
            // Scroll to bottom
            var chatWindow = $('#messages');
            chatWindow.scrollTop(chatWindow[0].scrollHeight);
        }

        // Function to hide thinking indicator
        function hideThinkingIndicator() {
            $('#thinking-indicator').remove();
        }

        // Function to display user message
        function displayUserMessage(message) {
            const messageHtml = `
                <div class="usertalk-inner">
                    <div class="chatuser-img">
                        <img src="{% static 'assets/img/user.png' %}" class="img-responsive">
                    </div>
                    <div class="userright-msg">
                        <span>${message}</span>
                    </div>
                </div>
            `;
            
            $('#messages').append(messageHtml);
            
            // Scroll to bottom
            var chatWindow = $('#messages');
            chatWindow.scrollTop(chatWindow[0].scrollHeight);
        }
        {% comment %} function extractQuestions(text) {
            // Find the index of "recommended questions"
            const index = text.toLowerCase().indexOf("recommended question");
        
            // If "recommended questions" is not found, return an empty array
            if (index === -1) {
                return [];
            }
        
            // Get the substring after "recommended questions"
            const questionsText = text.substring(index + "Recommended Question".length);
        
            // Split the remaining text into an array of questions
            const questionsArray = questionsText.split(/\<br>/);
        
            // Remove any empty strings from the array
            const filteredQuestionsArray = questionsArray.filter(question => question.trim() !== "" && question.trim() !== undefined);
        
            // Return the array of questions
            return filteredQuestionsArray;
        } {% endcomment %}
        function extractQuestions(text) {
            //console.log(text.toLowerCase())
            if (typeof text !== 'string') return { filteredText: text, questions: [] };
        
            // Find the index of "Recommended Questions" (case-insensitive)
            //const recommendedIndex = text.toLowerCase().indexOf("recommended questions");
            const keywords = ["recommended questions", "recommended question", "recommended questions:</strong>", "recommended questions:<br>"];

            // Find the index of the first occurrence of any keyword (case-insensitive)
            let recommendedIndex = -1;
            for (const keyword of keywords) {
                const index = text.toLowerCase().indexOf(keyword);
                if (index !== -1) {
                    recommendedIndex = index;
                    break; // Stop searching once the first match is found
                }
            }
            // If "Recommended Questions" is not found, return the original text and an empty array
            if (recommendedIndex === -1) {
                return { filteredText: text, questions: [] };
            }
        
            // Extract the text after "Recommended Questions"
            let questionsText = text.substring(recommendedIndex);
        
            // Find the end of the "Recommended Questions" section
            const endRecommendedIndex = questionsText.toLowerCase().indexOf("<br><br>");
        
            if (endRecommendedIndex !== -1) {
                questionsText = questionsText.substring(0, endRecommendedIndex);
            }
        
            // Define a regex to match each question (looking for numbers or bullet points followed by question text)
            const questionRegex = /\d+\.\s.*?(?=<br>|$)/gs;
            const questionsArray = questionsText.match(questionRegex) || [];
        
            // Remove any empty questions and trim whitespace
            const filteredQuestionsArray = questionsArray.map(q => q.trim()).filter(q => q);
        
            // Remove the "Recommended Questions" section from the original text
            const filteredText = text.substring(0, recommendedIndex).trim();
        
            return { filteredText, questions: filteredQuestionsArray };
        }
        function extractTaskQuestion(text) {
            if (typeof text !== 'string') return { filteredText: text, hasTaskQuestion: false, taskQuestion: '' };
            
            // Define keywords to identify task-oriented or recommended questions
            const keywords = ["task-oriented question", "task oriented question", "task oriented question:</strong>", "task oriented question:<br>"];
            let word = '';
            
            // Find the index of any keyword in the text
            let taskIndex = -1;
            for (const keyword of keywords) {
                const index = text.toLowerCase().indexOf(keyword);
                if (index !== -1) {
                    taskIndex = index;
                    word = keyword;
                    break; // Stop searching once the first match is found
                }
            }
            
            let taskQuestion = '';
            let hasTaskQuestion = false;
            if (taskIndex !== -1) {
                // Extract the text after the found keyword
                let taskText = text.substring(taskIndex);
                
                // Find the end of the relevant section
                const endTaskIndex = taskText.toLowerCase().indexOf("<br><br>");
                if (endTaskIndex !== -1) {
                    taskText = taskText.substring(0, endTaskIndex);
                }
                
                // Create a dynamic regular expression to match the task question based on the found keyword
                const taskQuestionRegex = new RegExp(`${word}\\s*(.*?)\\s*(?=<br>|$)`, 'i');
                const taskMatch = taskText.match(taskQuestionRegex);
                if (taskMatch) {
                    taskQuestion = taskMatch[1].trim();
                    hasTaskQuestion = true;
                }
            }
            
            // Remove the relevant section from the original text
            let filteredTextTask = text;
            if (hasTaskQuestion) {
                const removeSectionRegex = new RegExp(`${word}.*?(?=<br><br>|$)`, 'i');
                filteredTextTask = filteredTextTask.replace(removeSectionRegex, '').trim();
            }
        
            return { filteredTextTask, hasTaskQuestion, taskQuestion };
        }            
        // Function to render questions inside a <ul> list
        function renderQuestions(questionsArray) {
            // Select the parent element where the <ul> list is located
            const chatSenderList = document.querySelector("#recommendquestions ul");

            // Clear existing questions
            chatSenderList.innerHTML = "";

            // Loop through questions and create HTML markup for each question
            questionsArray.forEach((question, index) => {
                if (question.startsWith(":")) {
                    question = question.substring(1).trim();
                }
            
                // Condition 2: Remove numbers followed by a dot and space from the start of the question if present
                if (/^\d+\.\s/.test(question)) {
                    question = question.replace(/^\d+\.\s/, "");
                }
                if (question==="")
                {
                    return;
                }
                // Create a new <li> element for each question
                const questionListItem = document.createElement('li');

                // Add the question text to the <li> element
                questionListItem.textContent = question;
                questionListItem.classList.add('form-control');
                questionListItem.classList.add('form-label');
                questionListItem.style.fontSize = '12px';
                questionListItem.style.color = 'navy blue';
                questionListItem.addEventListener('click', () => {
                    // Fill the clicked question into the textbox

                    document.getElementById('message-input').value = question;
                    
                    // Click the send button
                    document.getElementById('send-btn').click();
                });
                // Optionally, add classes or attributes to the <li> element
                // For example, add a class to the first item
                if (index === 0) {
                    questionListItem.classList.add('first-item');
                }

                // Append the <li> element to the <ul> list
                chatSenderList.appendChild(questionListItem);
            });
        }
        {% comment %} function processChatText(chatText) {
            // Check if the text contains "task oriented question"
            const isTask = chatText.toLowerCase().includes("task oriented question");
        
            // If "task oriented question" exists, remove it
            if (isTask) {
                chatText = chatText.substring(chatText.indexOf("task oriented question") + "task oriented question".length);
            }
        
            // Check if the text contains "recommended question"
            const isRecommended = chatText.toLowerCase().includes("recommended question");
        
            // If "recommended question" exists, remove any text after it
            if (isRecommended) {
                chatText = chatText.substring(0, chatText.toLowerCase().indexOf("recommended question"));
            }
        
            // If neither "task oriented question" nor "recommended question" is found,
            // return the original text
            if (!isTask && !isRecommended) {
                return { chatMessage: chatText, isTask: false };
            }
        
            // Replace escape sequences with their corresponding characters
            chatText = chatText.replace(/\\\\n/g, "<br>").replace(/\\\\n\\\\n/g, "<br><br>").replace(/\\\*\\\*(.*?)\\\*\\\*/g, '<strong>$1</strong>').replace(/\\\\'/g, "'");
            
            return { chatMessage: chatText, isTask: isTask };
        } {% endcomment %}
        
            function updateMessages() {
                $.ajax({
                    url: `{% url 'get_messages' %}?uid=${parseInt(uid)}&cid=${parseInt(cid)}`,
                    type: 'GET',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        console.log("update message data -> ",data)
                        if (data.None=== null)
                        {
                            console.log("Null fetched in messages")
                        }
                        else{
                            var messages = data.messages;
                        // Assuming data is an array of chat objects
                        $('#messages').empty(); // Clear previous messages
                        
                        messages.forEach(function(chat) {
                            var messageHtml;
                            //console.log("chat: ",chat)
                            //console.log(chat[0])
                            var chatMessage = chat[0].replace(/\\n/g, "<br>").replace(/\\n\\n/g, "<br><br>").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\\'/g, "'").replace(/###/g, '');;
                            //console.log("Chat mesage in foreach lopp\n",chatMessage)
                            chatMessage = removeAnswerPrefix(chatMessage);
                            //Questionsrecommended = extractQuestions(chatMessage);
                            //console.log(chatMessage)
                            const { filteredText, questions } = extractQuestions(chatMessage);
                            //console.log(questions)

                            const { filteredTextTask, hasTaskQuestion, taskQuestion } = extractTaskQuestion(filteredText);
                            //console.log(filteredTextTask,hasTaskQuestion,"\n\n\n",taskQuestion)
                            console.log(hasTaskQuestion)
                            renderQuestions(questions);
                            //var chatTextResult = processChatText(chatMessage);
                            // Access chatMessage and isTask from the result object
                            chatMessage = filteredTextTask;
                            var processedIsTask = hasTaskQuestion
                            //console.log(processedIsTask,chatMessage)
                if (chat[1] == "user") {
                    messageHtml = `
                        <div class="usertalk-inner reply-inner">
                            <div class="chatuser-img">
                                <img src="${chat[3].profilepic}" class="img-responsive">
                            </div>
                            <div class="userleft-msg">
                                <span style="color: navy;">${chatMessage}</span>
                                <div class="msg-dt">
                                    <label>${chat[2]}</label>   
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    messageHtml = `
                        <div class="usertalk-inner" >
                            <div class="chatuser-img">
                                <img src="${chat[3].coach_profile_image}" class="img-responsive">
                            </div>
                            <div class="userleft-msg">
                                <span style="color: navy;">${chatMessage}</span>
                                <p hidden>${chat[4]}</p>
                                <div class="msg-dt">
                                    <label>${chat[2]}</label>
                                        ${processedIsTask ? '<div class="action-button-list"><button class="btn-scolor task_button" onclick="fetch_task()"><i class="ri-add-line"></i>Add to task</button></div>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                // Append the message to the messages container
                $('#messages').append(messageHtml);
                        });
                                var chatWindow = $('#messages');
                                chatWindow.scrollTop(chatWindow[0].scrollHeight);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading messages:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        // Chat WebSocket is working, so this is just for message history
                    }
                });
            };
            
        // Update messages when the page loads
        $(document).ready(function() {
                updateMessages();
                //scrollToBottom();
        });
        const typingreplyIndicatorHTML = `
            <div class="usertalk-inner reply-inner">
                <div class="chatuser-img">
                    <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                </div>
                <div class="userleft-msg">
                    <!-- typing -->
                    <span>
                        <div class="typing">
                            <span class="circle"></span>
                            <span class="circle"></span>
                            <span class="circle"></span>
                        </div>
                    </span>
                    <!-- puase btn  -->
                    <div class="msg-dt">
                        <button class="btn-scolor"><i class="ri-add-line"></i>Add to task</button>
                    </div>
                </div>
            </div>
        `;
        // Event listener for send button
        $(document).ready(function() {
            //scrollToBottom();
        const csr = $("input[name=csrfmiddlewaretoken]").val();
        $('#send-btn').click(function() {
            $('#messages').append(typingreplyIndicatorHTML);
            const message = $('#message-input').val().trim();
            console.log("Message on send button click , Message is-> ",message)
            var formData ={
                //'csrfmiddlewaretoken': csr,
                'csrfmiddlewaretoken':$( "#csrfmiddlewaretoken" ).val(),
                'message': message,
                'uid':uid,
                'cid':cid,
            };
            if (message !== '') {
                $.ajax({
                    url: "{% url 'send_message' %}",
                    method: 'POST',
                    data: formData,
                    //$('#messages').append(typingreplyIndicatorHTML),
                    success: function(response) {
                        // Display user message immediately
                        displayUserMessage(message);
                        
                        // Send to WebSocket
                        socket.send(JSON.stringify({'message': message}));
                        $('#message-input').val('');
                        
                        // Try to update from server (may fail with 404, but that's OK)
                        updateMessages();
                    }
                });
            }
        });
        const typingIndicatorHTML = `
            <div class="usertalk-inner" id="typing-indicator">
                <div class="chatuser-img">
                    <img src="{% static 'assets/img/chat-user.svg' %}" class="img-responsive">
                </div>
                <div class="userleft-msg">
                    <!-- typing -->
                    <span>
                        <div class="typing">
                            <span class="circle"></span>
                            <span class="circle"></span>
                            <span class="circle"></span>
                        </div>
                    </span>
                    <!-- puase btn  -->
                    <div class="msg-dt">
                        <button class="btn-scolor"><i class="ri-add-line"></i>Add to task</button>
                    </div>
                </div>
            </div>
        `;
        
        let typingIndicatorDisplayed = false;
        // Event listener for keyup event on input field
        $('#message-input').on('keyup', function() {
            // Check if the input field is empty
            if ($(this).val().trim() === '') {
                // If empty, remove the typing indicator
                $('#typing-indicator').remove();
                // Reset the flag
                typingIndicatorDisplayed = false;
            } else {
                // If not empty and typing indicator is not already displayed
                if (!typingIndicatorDisplayed) {
                    // Append the typing indicator HTML
                    $('#messages').append(typingIndicatorHTML);
                    // Set the flag to true
                    typingIndicatorDisplayed = true;
                }
            }
        }); 
    });
    // Handle Enter key press
    $('#message-input').keypress(function(event) {
        if (event.which === 13) {
            $('#send-btn').click();
        }
    });
    

    $('.view-chat').on('click', function() {
        // Get the coach ID from the data attribute
        var coachId = $(this).data('coach-id');
        var userId = {{ request.user.id }}; // This syntax is correct assuming you're rendering this script in a Django template
        
        // Generate the URL using JavaScript string formatting
        var chatUrl = "{% url 'chat' 0 0 %}";
        chatUrl = chatUrl.replace("0", userId).replace("0", coachId);
        
        // Redirect to the chat URL
        window.location.href = chatUrl;
    });

    if ($('.chat-sender-list ul').children().length === 0) {
        // If ul is empty, create a new li element with the message
        var messageLi = $('<li >').html('üòî There are no chats available at the moment.<br> <br> üí¨‚ú® Please chat with our experts and get your doubts cleared. ü§îüîç');
        messageLi.click(function() {
            window.location.href='{% url "coach" %}'; // Replace 'your_coach_url_here' with the actual URL
        });
        // Append the new li element to the ul
        $('.chat-sender-list ul').append(messageLi);
    }

    function fetch_task() {
        var answerElement = event.target.closest('.usertalk-inner').querySelector('span');
        var answer = answerElement.textContent.toString();  // Convert answer to string
        var chatIdElement = event.target.closest('.usertalk-inner').querySelector('p');
        var chat_id = chatIdElement.textContent.toString();  // Convert answer to string
        var formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('answer', answer);
        formData.append('chat_id', chat_id);
        alert("Extracting Task, Please wait few seconds")
        $.ajax({
            url: "{% url 'get_task' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // If the request is successful, alert the response
               if  (response.success)
               {
                    alert(response.message)
               }
               else
               {
                    alert(response.message)
               }
            },
            error: function(xhr, status, error) {
                // If there's an error with the request, alert an error message
                alert("Error: " + xhr.responseText);
            }
        });
    };
</script>
{% comment %} <script>
    document.addEventListener('DOMContentLoaded', function () {
        const isSubscribed =false;  // Replace this with actual subscription status
        const sendButton = document.getElementById('send-btn');
        const clickCountKey = 'sendBtnClickCount';
        const maxClicks = 1;
        
        // Initialize or retrieve the click count from localStorage
        let clickCount = parseInt(localStorage.getItem(clickCountKey), 10);
        if (isNaN(clickCount)) {
            clickCount = 0;
            localStorage.setItem(clickCountKey, clickCount);
        }
    
        // Update the data-click-count attribute
        sendButton.dataset.clickCount = clickCount;
    
        // Check if user is subscribed and handle click count
        if (isSubscribed) {
            sendButton.dataset.subscribed = 'true';
    
            if (clickCount >= maxClicks) {
                sendButton.classList.add('disabled');
                sendButton.style.pointerEvents = 'none';
                console.log('Send button already disabled after 3 clicks');
            }
        } else {
            sendButton.dataset.subscribed = 'false';
        }
    
        sendButton.addEventListener('click', function () {
            console.log("----")
            const isSubscribed = sendButton.dataset.subscribed === 'true';
            let clickCount = parseInt(sendButton.dataset.clickCount, 10);
    
            if (isSubscribed) {
                if (clickCount < maxClicks) {
                    
                    clickCount += 1;
                    sendButton.dataset.clickCount = clickCount;
                    localStorage.setItem(clickCountKey, clickCount);
                    console.log(`Button clicked ${clickCount} times`);
    
                    // Your send message logic here
    
                } else {
                    sendButton.classList.add('disabled');
                    sendButton.style.pointerEvents = 'none';
                    console.log('Send button disabled after 3 clicks');
                }
            } else {
                console.log('User is not subscribed');
            }
        });
    });
    </script>
     {% endcomment %}

    {% endblock %}